syntax = "proto3";
package qpov;

service Scheduler {
        // Render client API.
        rpc Get (GetRequest) returns (GetReply) {}
        rpc Renew (RenewRequest) returns (RenewReply) {}
        rpc Done (DoneRequest) returns (DoneReply) {}

        // Order handling API. Restricted.
        rpc Add (AddRequest) returns (AddReply) {}

        // Stats API. Restricted.
        rpc Leases (LeasesRequest) returns (stream LeasesReply) {}
}

message GetRequest {}

message GetReply {
        string lease_id = 1;
        string order_definition = 2;
}

message RenewRequest {
        string lease_id = 1;
        int32 extend_sec = 2;
}

message RenewReply {
        int64 new_timeout_sec = 1; // May be longer or shorter than now+extend_sec.
}

message DoneRequest {
        string lease_id = 1;
        bytes image = 2;
        bytes stdout = 3;
        bytes stderr = 4;
        string json_metadata = 5;
        // RenderingMetadata metadata = 6;
}

message DoneReply {}

message AddRequest {
        string order_definition = 1;
        // string destination = 2; // Directory to store the results as <file>.png and <file>.proto.
}

message AddReply {
        string order_id = 1;
}

message Lease {
        string order_id = 1;
        string lease_id = 2;
        bool done = 3;
        int64 user_id = 4;
        int64 created_ms = 5;
        int64 updated_ms = 6;
        int64 expires_ms = 7;
}

message LeasesRequest {
        bool done = 1;
}

message LeasesReply {
        Lease lease = 1;
}
